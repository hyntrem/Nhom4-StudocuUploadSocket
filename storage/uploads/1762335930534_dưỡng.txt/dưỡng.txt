A. Trong id="users-section"
Thêm khối div bộ lọc này ngay bên dưới thẻ button "Thêm Người Dùng Mới" và trước thẻ div chứa bảng (bg-white shadow...).

HTML

<div
  class="my-4 p-4 bg-white rounded-lg shadow flex items-center space-x-4"
>
  <label for="user-status-filter" class="text-sm font-medium text-gray-700"
    >Lọc theo Trạng thái:</label
  >
  <select
    id="user-status-filter"
    class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm"
  >
    <option value="">Tất cả Trạng thái</option>
    <option value="active">Active</option>
    <option value="locked">Locked</option>
  </select>
  <button
    onclick="loadAllUsers()"
    class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm"
  >
    Lọc
  </button>
</div>


Trong id="transactions-section"
Thêm khối div bộ lọc này ngay bên dưới thẻ p mô tả và trước thẻ div chứa bảng (bg-white shadow...).

HTML

<div
  class="my-4 p-4 bg-white rounded-lg shadow flex items-center space-x-4"
>
  <label
    for="transaction-status-filter"
    class="text-sm font-medium text-gray-700"
    >Lọc theo Trạng thái Thanh toán:</label
  >
  <select
    id="transaction-status-filter"
    class="block w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm"
  >
    <option value="">Tất cả</option>
    <option value="initiated">Chờ thanh toán</option>
    <option value="pending">Chờ duyệt</option>
    <option value="completed">Hoàn thành</option>
    <option value="failed">Thất bại</option>
  </select>
  <button
    onclick="loadAllTransactions()"
    class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm"
  >
    Lọc
  </button>
</div>

A. Thay thế loadAllUsers()
JavaScript

// Thay thế hàm loadAllUsers cũ
async function loadAllUsers() {
  try {
    // ĐỌC GIÁ TRỊ LỌC
    const statusFilter = document.getElementById("user-status-filter").value;
    let endpoint = "/admin/admin/users";
    if (statusFilter) {
      endpoint += `?status=${statusFilter}`;
    }

    const users = await apiRequest(endpoint); // Gọi API với filter
    const tbody = document.getElementById("users-table-body");
    if (users && Array.isArray(users)) {
      tbody.innerHTML = users
        .map(
          (user) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                              user.user_id
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              user.username
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              user.email
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              user.role
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                  user.status === "active"
                                    ? "bg-green-100 text-green-800"
                                    : "bg-red-100 text-red-800"
                                }">
                                    ${user.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                <button onclick="toggleUserLock(${
                                  user.user_id
                                })" class="text-indigo-600 hover:text-indigo-900">
                                    ${
                                      user.status === "active"
                                        ? "Lock"
                                        : "Unlock"
                                    }
                                </button>
                                <button onclick="deleteUser(${
                                  user.user_id
                                })" class="text-red-600 hover:text-red-900">Delete</button>
                                <button onclick="showUserActivity(${
                                  user.user_id
                                }, '${
            user.username
          }')" class="text-green-600 hover:text-green-900">Hoạt Động</button>
                            </td>
                        </tr>
                    `
        )
        .join("");
    }
  } catch (error) {}
}

D. Thay thế loadAllTransactions()
JavaScript

// Thay thế hàm loadAllTransactions cũ
async function loadAllTransactions() {
  try {
    // ĐỌC GIÁ TRỊ LỌC
    const statusFilter = document.getElementById(
      "transaction-status-filter"
    ).value;
    let endpoint = "/admin/admin/payments";
    if (statusFilter) {
      endpoint += `?status=${statusFilter}`;
    }

    const payments = await apiRequest(endpoint); // Gọi API với filter
    const tbody = document.getElementById("transactions-table-body");

    if (payments && Array.isArray(payments) && payments.length > 0) {
      tbody.innerHTML = payments
        .map(
          (p) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                              p.transaction_id
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              p.payment_id
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              p.buyer_username || "N/A"
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                              p.seller_username || "N/A"
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${parseFloat(
                              p.amount || 0
                            ).toLocaleString("vi-VN")} VNĐ</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatAdminPaymentMethod(
                              p.payment_method
                            )}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${formatAdminPaymentStatus(
                              p.payment_status
                            )}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                ${
                                  p.payment_status === "pending"
                                    ? `<button onclick="approvePayment(${p.payment_id})" class="text-indigo-600 hover:text-indigo-900 bg-indigo-100 hover:bg-indigo-200 px-3 py-1 rounded-md">Duyệt (Complete)</button>`
                                    : `<span class="text-gray-400">${
                                        p.payment_status === "completed"
                                          ? "Đã duyệt"
                                          : p.payment_status === "failed"
                                          ? "Thất bại"
                                          : "Chờ TT"
                                      }</span>`
                                }
                            </td>
                        </tr>
                    `
        )
        .join("");
    } else {
      tbody.innerHTML =
        '<tr><td colspan="8" class="text-center py-4 text-gray-500">Không có giao dịch nào khớp bộ lọc.</td></tr>';
    }
  } catch (error) {
    const tbody = document.getElementById("transactions-table-body");
    if (tbody)
      tbody.innerHTML =
        '<tr><td colspan="8" class="text-center py-4 text-red-500">Lỗi khi tải giao dịch.</td></tr>';
  }
}

admin-service/controllers/admin_controller.py
thay =

@admin_bp.route("/users", methods=["GET"])
@admin_required()
def get_all_users():
    """Lấy danh sách user từ User Service (có lọc)."""
    status = request.args.get('status')
    endpoint = "/users"
    if status:
        endpoint += f"?status={status}"
        
    data, status_code = call_user_service('GET', endpoint)
    return jsonify(data), status_code

@admin_bp.route("/payments", methods=["GET"])
@admin_required()
def get_all_payments():
    """Lấy tất cả payment từ Transaction Service (có lọc)."""
    status = request.args.get('status')
    endpoint = "/payments"
    if status:
        endpoint += f"?status={status}"

    data, status_code = call_transaction_service('GET', endpoint)
    return jsonify(data), status_code


user-service/controllers/internal_controller.py
Thay thế hàm internal_get_all_users:
@internal_bp.route("/users", methods=["GET"])
@internal_api_key_required()
def internal_get_all_users():
    """Admin service gọi để lấy tất cả user (có lọc)."""
    status = request.args.get('status')
    
    # Giả định UserLogic.get_all_users() trả về 1 list các object User
    # Lọc được thực hiện tại đây
    users = UserLogic.get_all_users() 
    
    if status:
        try:
            # Lọc trong Python
            users = [u for u in users if u.status == status]
        except AttributeError:
            logger.error("Đối tượng User không có thuộc tính 'status' để lọc.")
            # Có thể bỏ qua lỗi và trả về list đầy đủ
            pass
            
    return jsonify([serialize_user(u) for u in users]), 200


E. transaction-service/controllers/internal_controller.py
Thay thế hàm internal_get_all_payments. (Hàm này lọc bằng SQLAlchemy Query).

Python

# ... (imports và decorator giữ nguyên) ...

# --- Các Endpoint Nội Bộ cho Transaction/Payment ---

@internal_bp.route("/payments", methods=["GET"])
@internal_api_key_required()
def internal_get_all_payments():
    """Admin service gọi để lấy tất cả payment (join transaction và có lọc)."""
    try:
        status = request.args.get('status') # Lấy status từ query

        # Bắt đầu query
        query = (
            db.session.query(Payment)
            .join(Transaction, Payment.transaction_id == Transaction.transaction_id) 
        )
        
        # Áp dụng filter nếu có
        if status:
            query = query.filter(Payment.payment_status == status)
            
        # Sắp xếp và thực thi
        all_payments = (
            query.order_by(Payment.created_at.desc())
            .all()
        )
        
        # Serialize dùng hàm đã có (hàm này sẽ gọi user-service để lấy username)
        return jsonify([serialize_payment_for_admin(p) for p in all_payments]), 200
    except Exception as e:
        logger.error(f"Lỗi internal_get_all_payments: {e}", exc_info=True)
        return jsonify(error="Lỗi máy chủ nội bộ khi lấy payments."), 500
